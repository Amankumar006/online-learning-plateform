
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // Check if a user is authenticated.
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the requesting user is the owner of a document.
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get the role of the requesting user.
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Check if the requesting user is an admin.
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // --- Collection: users ---
    match /users/{userId} {
      // Admins can read/write any user profile.
      allow read, write: if isAdmin();
      // Users can read their own profile.
      allow get: if isOwner(userId);
      // Users can update specific fields on their own profile.
      allow update: if isOwner(userId) && request.resource.data.keys().hasOnly(['name', 'photoURL', 'lastCheckedAnnouncementsAt', 'lastLessonRequestAt']);
    }

    // --- Collection: lessons ---
    match /lessons/{lessonId} {
      // Any authenticated user can read lessons.
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete lessons.
      allow write: if isAdmin();
    }

    // --- Collection: announcements & emailQueue ---
    match /announcements/{announcementId} {
      // Any authenticated user can read announcements.
      allow read: if isAuthenticated();
      // Only admins can create announcements.
      allow write: if isAdmin();
    }

    match /emailQueue/{emailId} {
      // No client-side access. This is managed by the server/extensions.
      allow read, write: if false;
    }


    // --- Collection: lessonRequests ---
    match /lessonRequests/{requestId} {
      // Admins can read all requests.
      allow read: if isAdmin();
      // Users can create requests for themselves if the status is pending.
      allow create: if isOwner(request.resource.data.userId) && request.resource.data.status == 'pending';
      // No one can update or delete from the client.
      allow update, delete: if false;
    }

    // --- Collection: exercises ---
    match /exercises/{exerciseId} {
      // Admins can do anything.
      allow read, write: if isAdmin();

      // This is the core rule for student read access.
      // A user can read an exercise if:
      // 1. It's a public, lesson-based exercise (isCustom == false).
      // OR
      // 2. It's a custom exercise that they own (isCustom == true AND userId matches).
      // This single rule correctly validates BOTH getting a single public lesson AND querying for one's own custom exercises.
      allow read: if isAuthenticated() && (resource.data.isCustom == false || isOwner(resource.data.userId));

      // Users can create exercises only if they are marked as custom and for themselves.
      allow create: if isOwner(request.resource.data.userId) && request.resource.data.isCustom == true;

      // Users can delete only their own custom exercises.
      allow delete: if isOwner(resource.data.userId) && resource.data.isCustom == true;

      // Users cannot update exercises directly from the client.
      allow update: if false;
    }

    // --- Collection: exerciseResponses ---
    match /exerciseResponses/{responseId} {
      // Admins can read all responses.
      allow read: if isAdmin();

      // This rule allows a user to read their own exercise responses.
      // It works for both getting a single document and for querying
      // where("userId", "==", uid), because Firestore can verify the query constraint
      // against this rule.
      allow read: if isOwner(resource.data.userId);

      // A user can create or update their own response.
      // We check the incoming data's userId to secure the write.
      allow write: if isOwner(request.resource.data.userId);
    }
  }
}
