rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Use `exists()` to prevent errors on non-existent user docs during signup.
      // Checks if the authenticated user has an 'admin' role in their user document.
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- User Profiles ---
    match /users/{userId} {
      // Users can read any profile (e.g., for admin viewing students).
      // Users can only create and update their OWN profile. Admins can update any profile.
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
    }

    // --- Lessons ---
    match /lessons/{lessonId} {
      // Any authenticated user can read lessons. Only admins can create/update/delete.
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Exercises (This is the critical part) ---
    match /exercises/{exerciseId} {
      // Admin Override: Admins can do anything with any exercise. This rule is checked first.
      allow read, write: if isAdmin();

      // Student Read Rule:
      allow read: if isAuthenticated() && (
        // Condition 1: Allow reading any public (non-custom) exercise.
        resource.data.isCustom == false ||
        // Condition 2: Allow reading a custom exercise if the user is the owner.
        // This is crucial for the `getCustomExercisesForUser` query.
        (resource.data.isCustom == true && resource.data.userId == request.auth.uid)
      );

      // Student Write Rules:
      // Allow creating a custom exercise for oneself.
      allow create: if isAuthenticated()
                    && request.resource.data.isCustom == true
                    && request.resource.data.userId == request.auth.uid;
      
      // Allow updating or deleting one's own custom exercises.
      allow update, delete: if isAuthenticated()
                           && resource.data.isCustom == true
                           && resource.data.userId == request.auth.uid;
    }

    // --- Exercise Responses ---
    match /exerciseResponses/{responseId} {
      // A user can read and write their own exercise responses.
      // `request.resource.data.userId` is for writes (create/update).
      // `resource.data.userId` is for reads.
      allow read, write: if (isAuthenticated() && request.auth.uid == resource.data.userId)
                      || (isAuthenticated() && request.auth.uid == request.resource.data.userId);
      
      // Admin override for viewing/managing responses.
      allow read, write: if isAdmin();
    }
    
    // --- Other Collections ---
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /lessonRequests/{requestId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAdmin();
    }

    match /emailQueue/{emailId} {
      // This collection is write-only for the backend.
      // We allow admins to create for the announcement feature.
      allow create: if isAdmin();
      // No one should read the email queue from the client.
      allow read, update, delete: if false;
    }
  }
}
