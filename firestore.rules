rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to keep rules DRY
    function isSignedIn() {
      return request.auth != null;
    }

    function isStudent() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    //----------------------------------------------------------------------
    //  /users/{userId}
    //----------------------------------------------------------------------
    match /users/{userId} {
      // Admins can read any user profile.
      // Students can only read their own profile.
      allow get: if isAdmin() || isOwner(userId);

      // Admins can see the list of all users.
      // Students cannot list all users.
      allow list: if isAdmin();
      
      // Admins can update any user's role.
      // Students can only update their own profile fields (like name).
      allow update: if isAdmin() || (isOwner(userId) && request.resource.data.keys().hasOnly(['name', 'photoURL', 'lastCheckedAnnouncementsAt', 'lastLessonRequestAt', 'progress']));

      // Only an admin can create a user document (though it's usually done via signup).
      // A user document is created for a user when they sign up.
      allow create: if isSignedIn();
    }

    //----------------------------------------------------------------------
    //  /lessons/{lessonId}
    //----------------------------------------------------------------------
    match /lessons/{lessonId} {
      // Any signed-in user can read lesson content.
      allow read: if isSignedIn();

      // Only admins can create, update, or delete lessons.
      allow write: if isAdmin();
    }
    
    //----------------------------------------------------------------------
    //  /exercises/{exerciseId}
    //----------------------------------------------------------------------
    match /exercises/{exerciseId} {
      // READ:
      // An exercise is readable if it's NOT a custom exercise.
      // OR if it IS a custom exercise and the user is the owner.
      function isReadable() {
        return resource.data.isCustom == false || (resource.data.isCustom == true && isOwner(resource.data.userId));
      }

      // Allow reading a single exercise if it's readable.
      allow get: if isSignedIn() && isReadable();
      
      // Allow listing exercises under two conditions:
      // 1. The query is for a specific lesson (e.g., getExercises).
      // 2. The query is for a specific user's custom exercises (e.g., getCustomExercisesForUser).
      allow list: if isSignedIn() && 
                      (
                        (request.query.where.size() == 1 && request.query.where[0].fieldPath == 'lessonId') ||
                        (request.query.where.size() == 2 && request.query.where[0].fieldPath == 'userId' && request.query.where[0].value == request.auth.uid)
                      );

      // WRITE:
      // Allow creating an exercise if:
      // 1. It's a custom exercise being created by the owner.
      // 2. An admin is creating it.
      allow create: if isSignedIn() && (
        (request.resource.data.isCustom == true && isOwner(request.resource.data.userId)) || isAdmin()
      );
      
      // Allow updating/deleting an exercise if:
      // 1. It's a custom exercise and the user is the owner.
      // 2. An admin is performing the action.
      allow update, delete: if isSignedIn() && (
        (resource.data.isCustom == true && isOwner(resource.data.userId)) || isAdmin()
      );
    }
    
    //----------------------------------------------------------------------
    //  /exerciseResponses/{responseId}
    //----------------------------------------------------------------------
    match /exerciseResponses/{responseId} {
      // Allow a user to list their own responses via a query.
      // This rule specifically allows the query in `getAllUserResponses`.
      allow list: if isSignedIn() && 
                   request.query.where.size() == 1 &&
                   request.query.where[0].fieldPath == 'userId' &&
                   request.query.where[0].op == '==' &&
                   request.query.where[0].value == request.auth.uid;
      
      // Allow reading a single document if the user is the owner.
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Allow creating/updating their own response.
      allow create, update: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Users cannot delete their responses.
      allow delete: if false;
    }
    
    //----------------------------------------------------------------------
    //  /lessonRequests/{requestId}
    //----------------------------------------------------------------------
    match /lessonRequests/{requestId} {
      // Admins can read all requests.
      // Students can read their own request.
      allow get: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow list: if isAdmin();

      // Students can create a request for themselves.
      allow create: if isStudent() && request.resource.data.userId == request.auth.uid;
      
      // Only Admins can update a request (to approve/reject it).
      allow update: if isAdmin();
    }
    
    //----------------------------------------------------------------------
    //  /announcements/{announcementId}
    //----------------------------------------------------------------------
    match /announcements/{announcementId} {
      // Any signed-in user can read announcements.
      allow read: if isSignedIn();

      // Only admins can create announcements.
      allow write: if isAdmin();
    }
    
    //----------------------------------------------------------------------
    //  /emailQueue/{emailId}
    //----------------------------------------------------------------------
    // This collection is write-only for admins (via the createCustomAnnouncement function).
    // It is read and processed by the "Trigger Email" Firebase Extension, not the app clients.
    // So, no client-side read/write access is needed.
    match /emailQueue/{emailId} {
      allow read, write: if false; // Deny all client access
    }
  }
}
