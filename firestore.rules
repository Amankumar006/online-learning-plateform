rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    // Checks if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Validates user data structure and required fields
    function isValidUserData(data) {
      return data.keys().hasAll(['uid', 'email', 'role', 'progress', 'loginStreak', 'lastLoginDate']) &&
             data.role in ['student', 'admin'] &&
             data.uid == request.auth.uid;
    }

    // Validates lesson data structure
    function isValidLessonData(data) {
      // Check that core required fields exist and validate difficulty value
      return data.keys().hasAll(['title', 'subject', 'description', 'difficulty']) &&
             data.difficulty in ['Beginner', 'Intermediate', 'Advanced'];
      // Allow additional optional fields without strict validation
      // This accommodates sections, image, tags, gradeLevel, ageGroup, etc.
    }

    // Validates exercise data structure
    function isValidExerciseData(data) {
      // Basic validation for all exercise types
      return data.keys().hasAll(['lessonId', 'difficulty', 'type']) &&
             data.type in ['mcq', 'true_false', 'long_form', 'fill_in_the_blanks'] &&
             data.difficulty is number && data.difficulty >= 1 && data.difficulty <= 3;
    }

    // Validates study room data structure
    function isValidStudyRoomData(data) {
      return data.keys().hasAll(['ownerId', 'name', 'visibility', 'isPublic', 'status', 'editorIds']) &&
             data.visibility in ['public', 'private'] &&
             data.status in ['active', 'ended'] &&
             data.ownerId == request.auth.uid;
    }

    // =================================
    // User Management
    // =================================

    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if request.auth.uid == userId && isValidUserData(request.resource.data);
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false; // Users should never be deleted

      // User's personal subcollections (tasks, notes)
      match /tasks/{taskId} {
        allow read, write, delete: if request.auth.uid == userId;
      }

      match /notes/{noteId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    // =================================
    // Core Content
    // =================================

    match /lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                      (resource == null || isValidExerciseData(request.resource.data));
      allow update: if isAuthenticated() && 
                      isValidExerciseData(request.resource.data);
      allow delete: if isAuthenticated();
    }
    
    match /exerciseResponses/{responseId} {
      allow read: if isAuthenticated() && 
                    (resource == null || resource.data.userId == request.auth.uid);
      
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
      
      allow delete: if false; // Preserve response history
    }

    // =================================
    // Admin & System
    // =================================

    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    match /lessonRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    match /emailQueue/{emailId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAuthenticated();
    }
    
    // =================================
    // Study Rooms & Collaboration
    // =================================
    
    match /studyRooms/{roomId} {
      allow read, write: if isAuthenticated();
      
      // Study room participants
      match /participants/{userId} {
        allow read, write, delete: if isAuthenticated();
      }
      
      // WebRTC peer connections
      match /peers/{peerId} {
        allow read, write, delete: if isAuthenticated();
        
        // WebRTC connections between peers
        match /connections/{connectionId} {
          allow read, write, delete: if isAuthenticated();

          // ICE candidates for WebRTC
          match /iceCandidates/{candidateId} {
             allow read, write, delete: if isAuthenticated();
          }
        }
      }

      // Chat messages in study rooms
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false; // Messages are immutable
      }

      // Shared resources in study rooms
      match /resources/{resourceId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow delete: if isAuthenticated();
        allow update: if false; // Resources are immutable once created
      }
    }

    // =================================
    // Conversation Memory & AI Features
    // =================================
    
    // Conversation memory for tracking user learning patterns
    match /conversationMemory/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Conversation sessions for detailed chat history
    match /conversationSessions/{sessionId} {
      allow read, write: if isAuthenticated() && 
                           (resource == null || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
    }
    
    // Media content for multi-modal conversations
    match /mediaContent/{mediaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // =================================
    // Additional Security Rules
    // =================================

    // Prevent access to any other collections not explicitly defined
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// =================================
// Storage Rules (for completeness)
// =================================
// Note: This should be in a separate storage.rules file
/*
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Lesson images and audio
    match /lessons/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // User-generated content
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Exercise attachments
    match /exercises/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
*/