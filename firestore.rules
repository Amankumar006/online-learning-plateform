rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if a user is authenticated
    function isSignedIn() {
      return request.auth.uid != null;
    }

    // --- COLLECTION: users ---
    match /users/{userId} {
      // Admins can read/write any user document.
      // A user can read and update their own document.
      allow read, write: if isSignedIn() && (isAdmin() || request.auth.uid == userId);
    }

    // --- COLLECTION: lessons ---
    match /lessons/{lessonId} {
      // Any signed-in user can read lessons.
      allow get, list: if isSignedIn();
      // Only admins can create, update, or delete lessons.
      allow write: if isAdmin();
    }

    // --- COLLECTION: exercises ---
    match /exercises/{exerciseId} {
      // Admins can do anything.
      allow read, write: if isAdmin();
      
      // Students can GET any non-custom exercise, or their own custom exercises.
      allow get: if isSignedIn() && (resource.data.isCustom == false || resource.data.userId == request.auth.uid);
      
      // Students can LIST exercises. Client-side queries are responsible for filtering.
      // The `get` rule above provides the final document-level security check.
      allow list: if isSignedIn();

      // Students can CREATE exercises only if they are custom and for themselves.
      allow create: if isSignedIn() && request.resource.data.isCustom == true && request.resource.data.userId == request.auth.uid;

      // Students can only UPDATE or DELETE their own custom exercises.
      allow update, delete: if isSignedIn() && resource.data.isCustom == true && resource.data.userId == request.auth.uid;
    }

    // --- COLLECTION: exerciseResponses ---
    match /exerciseResponses/{responseId} {
      // Admins can read any response.
      allow get, list: if isAdmin();

      // A user can read or write their own response document.
      allow get, write: if isSignedIn() && request.auth.uid == responseId.split('_')[0];
      
      // A user can list their own responses (e.g., for a specific lesson or all of them).
      // The query MUST include a `where("userId", "==", request.auth.uid)` clause.
      allow list: if isSignedIn() && request.query.where[0].field == 'userId' && request.query.where[0].op == '==' && request.query.where[0].value == request.auth.uid;
    }
    
    // --- COLLECTION: announcements ---
    match /announcements/{announcementId} {
      // Any authenticated user can read announcements.
      allow read: if isSignedIn();
      // Only admins can create them.
      allow create: if isAdmin();
    }
    
    // --- COLLECTION: emailQueue ---
    match /emailQueue/{emailId} {
      // Only admins can create email jobs.
      allow create: if isAdmin();
    }
    
    // --- COLLECTION: lessonRequests ---
    match /lessonRequests/{requestId} {
      // Admins can read/write all requests.
      allow read, write: if isAdmin();
      // Users can create requests for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
  }
}
