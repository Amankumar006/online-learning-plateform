rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    // Checks if the requesting user is a registered admin.
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Checks if a user is authenticated.
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Checks if the user making the request is the owner of the resource.
    function isResourceOwner(resource) {
      return request.auth.uid == resource.data.userId;
    }

    // =================================
    // User Management
    // =================================

    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if request.auth.uid == userId;
      allow delete: if false;

      // Rules for user's tasks and notes subcollections
      match /{subcollection}/{docId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    // =================================
    // Core Content
    // =================================

    match /lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // create, update, delete
    }

    match /exercises/{exerciseId} {
      allow read: if isAuthenticated() && (isAdmin() || resource.data.isCustom == false || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && (isAdmin() || (request.resource.data.isCustom == true && isResourceOwner(request.resource)));
      allow update: if isAdmin();
      allow delete: if isAuthenticated() && (isAdmin() || (get(/databases/$(database)/documents/exercises/$(exerciseId)).data.userId == request.auth.uid));
    }
    
    match /exerciseResponses/{responseId} {
      allow read: if isAuthenticated() && (isResourceOwner(resource) || isAdmin());
      allow write: if isAuthenticated() && isResourceOwner(request.resource);
    }

    // =================================
    // Admin & System
    // =================================

    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /lessonRequests/{requestId} {
      allow read, update, delete: if isAdmin();
      allow create: if isAuthenticated() && isResourceOwner(request.resource);
    }

    match /emailQueue/{emailId} {
      allow create: if isAdmin();
      allow read, update, delete: if false;
    }
    
    // =================================
    // Study Rooms
    // =================================
    match /studyRooms/{roomId} {

      // Room-level access
      allow get: if isAuthenticated() && (resource.data.isPublic == true || request.auth.uid in resource.data.editorIds);
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      // --- Subcollection Rules ---

      // Any user allowed in the room can see who is participating.
      // A user can only create/update their own participant document.
      // The owner can remove anyone.
      match /participants/{userId} {
        allow read: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.isPublic == true || request.auth.uid in get(/databases/$(database)/documents/studyRooms/$(roomId)).data.editorIds);
        allow write: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && (request.auth.uid == userId || get(/databases/$(database)/documents/studyRooms/$(roomId)).data.ownerId == request.auth.uid);
      }
      
      // A user can see the list of peers if they are allowed in the room.
      // A user can only create/manage their own peer document.
      match /peers/{peerId} {
        allow list, get: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.isPublic == true || request.auth.uid in get(/databases/$(database)/documents/studyRooms/$(roomId)).data.editorIds);
        allow write, delete: if isAuthenticated() && request.auth.uid == peerId;
        
        // A user can see the list of connections for a peer.
        // A user can only create a connection document for themself, targeting another peer.
        // The peer or the connection owner can modify/delete it.
        match /connections/{connectionId} {
          allow list, get: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.isPublic == true || request.auth.uid in get(/databases/$(database)/documents/studyRooms/$(roomId)).data.editorIds);
          allow write, delete: if isAuthenticated() && (request.auth.uid == peerId || request.auth.uid == connectionId);

          // A user can see the list of candidates for a connection.
          // The peer or connection owner can create candidates.
          match /iceCandidates/{candidateId} {
             allow list, get: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.isPublic == true || request.auth.uid in get(/databases/$(database)/documents/studyRooms/$(roomId)).data.editorIds);
             allow write, delete: if isAuthenticated() && (request.auth.uid == peerId || request.auth.uid == connectionId);
          }
        }
      }

      // Any user allowed in the room can read messages.
      // A user can only create messages as themself or as 'buddy-ai'.
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.isPublic == true || request.auth.uid in get(/databases/$(database)/documents/studyRooms/$(roomId)).data.editorIds);
        allow create: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || request.resource.data.userId == 'buddy-ai');
        allow update, delete: if false;
      }

      // Any user allowed in the room can read resources.
      // A user can only create resources as themself.
      // The owner or original creator can delete resources.
      match /resources/{resourceId} {
        allow read: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.isPublic == true || request.auth.uid in get(/databases/$(database)/documents/studyRooms/$(roomId)).data.editorIds);
        allow create: if isAuthenticated() && request.resource.data.addedByUserId == request.auth.uid;
        allow delete: if isAuthenticated() && (get(/databases/$(database)/documents/studyRooms/$(roomId)).data.ownerId == request.auth.uid || resource.data.addedByUserId == request.auth.uid);
        allow update: if false;
      }
    }
  }
}
